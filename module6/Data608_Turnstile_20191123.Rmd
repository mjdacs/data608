---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)

data <- read_csv("http://web.mta.info/developers/data/nyct/turnstile/turnstile_191123.txt") 
```
```{r}
dim(data)
```

```{r}
sapply(data, function(x) sum(is.na(x)))
```

```{r}
unique(data$DIVISION)
```
```{r}
df <- data %>% filter(DIVISION %in% c("BMT", "IND", "IRT"))
df
```

```{r}
df$TIME <- as.character(df$TIME)
df$ENTRIES <- as.numeric(df$ENTRIES)
df$EXITS <- as.numeric(df$EXITS)
df 
```

Now that structure is understood, get the head of the data set. The first six rows are displayed to give you a snapshot. 

```{r}
unique(df$TIME)
```


```{r}
# dfdt <- df %>% filter(TIME %in% c("03:00:00", "07:00:00", "11:00:00" ,"15:00:00", "19:00:00", "23:00:00",
#                           "01:00:00", "05:00:00", "09:00:00", "13:00:00", "17:00:00", "21:00:00",
#                           "00:00:00", "04:00:00" ,"08:00:00", "12:00:00", "16:00:00", "20:00:00" ,
#                           "02:00:00" ,"06:00:00" ,"10:00:00", "14:00:00" ,"18:00:00", "22:00:00" ))

# dfdt <- df %>% filter(DATE %in% c("11/16/2019", "11/22/2019"),
#                     TIME %in% c("03:00:00", "23:00:00",
#                                 "01:00:00", "21:00:00",
#                                 "00:00:00", "20:00:00",
#                                 "02:00:00", "22:00:00" ))


# dfdt <- df %>%
#   filter(
#           (DATE == "11/16/2019" & TIME %in% c("00:00:00","01:00:00","02:00:00","03:00:00")) |
#           (DATE == "11/22/2019" & TIME %in% c("20:00:00","21:00:00","22:00:00", "23:00:00"))
#         )


df_audit1 <- df %>%
  filter(
          (DATE == "11/16/2019" & TIME %in% c("00:00:00")) |
          (DATE == "11/22/2019" & TIME %in% c("20:00:00"))
        )

df_audit2 <- df %>%
  filter(
          (DATE == "11/16/2019" & TIME %in% c("01:00:00")) |
          (DATE == "11/22/2019" & TIME %in% c("21:00:00"))
        )

df_audit3 <- df %>%
  filter(
          (DATE == "11/16/2019" & TIME %in% c("02:00:00")) |
          (DATE == "11/22/2019" & TIME %in% c("22:00:00"))
        )

df_audit4 <- df %>%
  filter(
          (DATE == "11/16/2019" & TIME %in% c("03:00:00")) |
          (DATE == "11/22/2019" & TIME %in% c("23:00:00"))
        )
# 
# dfdt %>% filter(DATE == "11/16/2019" & TIME %in% c("00:00:00",
#                                                   "01:00:00",
#                                                   "02:00:00",
#                                                   "03:00:00") )
df_audit1
```
```{r}
df_audit1
```
```{r}
df_audit1 %>% 
  mutate(Total_Enter = ENTRIES - lag(ENTRIES, 1),
                Total_Exit = EXITS - lag(EXITS, 1)) %>% 
  filter(Total_Enter > 0 & DATE == "11/22/2019") %>% 
  group_by(STATION) %>% 
  summarise(Week_Total_Entries = sum(Total_Enter),
            Week_Total_Exits = sum(Total_Exit)) %>% 
  arrange(desc(Week_Total_Entries))
```
```{r}
df_audit1 %>% 
  select(SCP, STATION, DATE, TIME, DESC, ENTRIES, EXITS) %>% 
  filter(STATION == "ALLERTON AV")
```


```{r}
df_audit2
```
```{r}
df_audit2 %>% 
  mutate(Total_Enter = ENTRIES - lag(ENTRIES, 1),
                Total_Exit = EXITS - lag(EXITS, 1)) %>% 
  filter(Total_Enter > 0 & DATE == "11/22/2019") %>% 
  group_by(STATION) %>% 
  summarise(Week_Total_Entries = sum(Total_Enter),
            Week_Total_Exits = sum(Total_Exit)) %>% 
  arrange(desc(Week_Total_Entries))
```


```{r}
df_audit3
```

```{r}
df_audit3 %>% 
  mutate(Total_Enter = ENTRIES - lag(ENTRIES, 1),
                Total_Exit = EXITS - lag(EXITS, 1)) %>% 
  filter(Total_Enter > 0 & DATE == "11/22/2019") %>% 
  group_by(STATION) %>% 
  summarise(Week_Total_Entries = sum(Total_Enter),
            Week_Total_Exits = sum(Total_Exit)) %>% 
  arrange(desc(Week_Total_Entries))
```

```{r}
df_audit4
```
```{r}
df_audit4 %>% 
  mutate(Total_Enter = ENTRIES - lag(ENTRIES, 1),
                Total_Exit = EXITS - lag(EXITS, 1)) %>% 
  filter(Total_Enter > 0 & DATE == "11/22/2019") %>% 
  group_by(STATION) %>%
  filter(STATION != "42 ST-PORT AUTH" & !SCP %in% c("00-00-08", "00-00-09"),
         STATION != "RECTOR ST" & !SCP %in% c("01-03-00", "01-06-00"),
         STATION != "ALLERTON AV" & !SCP %in% c("00-00-00"),
         STATION != "47-50 STS ROCK" & !SCP %in% 
                           c("02-06-00","02-06-01",
                             "02-03-00","02-03-01","02-03-02","02-03-03",
                             "01-03-02",
                             "00-03-00", "00-03-01","00-03-02","00-03-03","00-03-04","00-03-05"),
         STATION != "86 ST" & !SCP %in% 
                            c("00-00-00", "00-00-01", "00-03-00", "00-03-01", "00-03-02")
         ) %>%       
  summarise(Week_Total_Entries = sum(Total_Enter),
            Week_Total_Exits = sum(Total_Exit)) %>% 
  arrange(desc(Week_Total_Entries))
```
```{r}
df_audit4 %>% 
  select(SCP, STATION, DATE, TIME, DESC, ENTRIES, EXITS) %>% 
  filter(STATION == "86 ST")
```

```{r}
dfdt %>% 
  mutate(Total_Enter = ENTRIES - lag(ENTRIES, 1),
                Total_Exit = EXITS - lag(EXITS, 1)) %>% 
  filter(Total_Enter > 0 & DATE == "11/22/2019") %>% 
  group_by(STATION) %>% 
  filter(STATION != "42 ST-PORT AUTH" & !SCP %in% c("00-00-08", "00-00-09")) %>% 
  summarise(Week_Total_Entries = sum(Total_Enter),
            Week_Total_Exits = sum(Total_Exit)) %>% 
  arrange(desc(Week_Total_Entries))

```
```{r}
dfdt %>% filter(STATION == "RECTOR ST") %>% 
  mutate(Total_Enter = ENTRIES - lag(ENTRIES, 1),
                Total_Exit = EXITS - lag(EXITS, 1)) 
  # filter(Total_Enter > 0 & DATE == "11/22/2019") %>% 
  # summarise(Week_Total_Entries = sum(Total_Enter),
  #           Week_Total_Exits = sum(Total_Exit))
```




```{r}
         (DATE == "11/16/2019" & TIME == "03:00:00") | (DATE == "11/22/2019" & TIME == "23:00:00")) %>%
  mutate(Total_Enter = ENTRIES - lag(ENTRIES, 1),
         Total_Exit =  EXITS - lag(EXITS, 1)) %>%
  filter(Total_Enter > 0 & DATE == "07/06/2018") %>%
  group_by(STATION) %>%
  summarise(Week_Total_Entries = sum(Total_Enter),
            Week_Total_Exits = sum(Total_Exit)) %>%
  mutate(Difference = Week_Total_Entries - Week_Total_Exits) %>% 
  filter(STATION != "LEXINGTON AV/63" & STATION != "BEACH 44 ST") %>%
  arrange(desc(Week_Total_Entries)) 
```

```{r}
data_viz <- data2[1:20,] %>% arrange(desc(Week_Total_Entries))
```

```{r message=FALSE}

ggplot(data_viz, aes(x = reorder(STATION, Week_Total_Entries), y = Week_Total_Entries)) +
  geom_bar(stat = "identity", fill = "navy", width = .5) +
  geom_text(aes(label=Week_Total_Entries),
            position=position_dodge(width = 0.1), hjust = -0.03, vjust = 0.5, size = 2.5) +
    coord_flip() +
  scale_y_continuous(labels = scales::comma) +
  theme(text = element_text(size = 10)) +
  labs(title = "20 Stations for Week Ending 7/6/2018",
       subtitle = "Total turnstile entries at each station. Data courtesty of mta.info",
       caption = "mdac",
       x = "Station",
       y = "Entries per station") 
  
ggsave("mdacplot.png")
```

```{r}
data_viz_low <- tail(data2,20) %>% 
  mutate(Total_traffic = Week_Total_Entries + Week_Total_Exits) %>% 
  select(STATION, Total_traffic) %>% 
  arrange(Total_traffic)

data_viz_low
```




```{r message = FALSE}

ggplot(data_viz_low, aes(x = reorder(STATION, -Total_traffic), y = Total_traffic)) +
  geom_bar(stat = "identity", fill = "navy", width = .5) +
  geom_text(aes(label = Total_traffic),
            position = position_dodge(width = 0.1), hjust = -0.03, vjust = 0.5, size = 2.5) +
  coord_flip() +
  scale_y_continuous(labels = scales::comma) +
  theme(text = element_text(size = 10)) +
  labs(title = "20 Slowest Stations for Week Ending 7/6/2018",
       subtitle = "Total turnstile entries and exits. Data courtesty of mta.info",
       caption = "mdac",
       x = "Station",
       y = "Entries per station") 
  


ggsave("mdacplot2.png")
```


```{r}
library(tidyverse)
library(lubridate)
dk <- read_csv("http://web.mta.info/developers/data/nyct/turnstile/turnstile_191123.txt")

dk<- dk %>% mutate(DATE = mdy(DATE),
                        ENTRIES = as.integer(ENTRIES),
                        EXITS = as.integer(EXITS))

```
```{r}
str(dk)
```


```{r}
dk %>% 
  filter(DATE == mdy("11/16/2019") & TIME <= "03:00:00" & TIME > "00:00:00")
```

